<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>éŸ³å£°å†ç”Ÿ + ãƒã‚¤ã‚¯ + éŸ³é‡èª¿æ•´</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
  >
</head>

<body>
   <main class="container">
  <h2>ğŸµ éŸ³å£°å†ç”Ÿï¼ˆaudioã‚¿ã‚° & Phaserï¼‰+ ğŸ¤ ãƒã‚¤ã‚¯ + ğŸ”Š éŸ³é‡èª¿æ•´</h2>

  <p id="mic-status">ãƒã‚¤ã‚¯çŠ¶æ…‹: æœªç¢ºèª</p>

  <!-- å„ç¨®ãƒœã‚¿ãƒ³ -->
  <button id="mic-btn">ğŸ¤ ãƒã‚¤ã‚¯ã‚’ä½¿ã†</button>
  <br><br>

  <!-- audioã‚¿ã‚°å†ç”Ÿ -->
  <button id="audio-play-btn">â–¶ï¸ audioã§å†ç”Ÿ</button>
  <br><br>

  <!-- Phaserå†ç”Ÿ -->
  <button id="phaser-play-btn">â–¶ï¸ Phaserã§å†ç”Ÿ</button>
  <br><br>

  <!-- éŸ³é‡èª¿æ•´ -->
  <button id="volume-up">ğŸ”Š éŸ³é‡ã‚¢ãƒƒãƒ—</button>
  <button id="volume-down">ğŸ”‰ éŸ³é‡ãƒ€ã‚¦ãƒ³</button>
  <br><br>

  <!-- ãƒã‚¤ãƒ†ã‚£ãƒ–audioã‚¿ã‚° -->
  <audio id="audio-player" loop>
    <source src="./test.mp3" type="audio/mpeg">
    ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ audio ã‚¿ã‚°ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
  </audio>

  <!-- Phaserã®æç”»é ˜åŸŸï¼ˆè¦‹ãˆãªã„ï¼‰ -->
  <div id="game" style="display:none;"></div>
  </main>

  <script>
    // ===== audioé–¢é€£ =====
    // audioã‚¿ã‚°è¦ç´ å–å¾—
    const audioEl = document.getElementById("audio-player");

    // audio å†ç”Ÿ/åœæ­¢
    document.getElementById("audio-play-btn").addEventListener("click", (e) => {
      if (audioEl.paused) {
        audioEl.play();
        e.target.innerHTML = "â¹ï¸ audioåœæ­¢"
      } else {
        audioEl.pause();
        e.target.innerHTML = "â–¶ï¸ audioã§å†ç”Ÿ"
      }
    });


    // ===== Phaseré–¢é€£ =====
    let game = null;
    let bgm = null;

    const config = {
      type: Phaser.AUTO,
      width: 1,
      height: 1,
      parent: 'game',
      scene: {
        preload: function () {
          this.load.audio('bgm', ['./test.mp3']);
        },
        create: function () {
          bgm = this.sound.add('bgm', { loop: true, volume: 1 });
        }
      },
      audio: {
        disableWebAudio: false
      }
    };

    // Phaserå†ç”Ÿãƒœã‚¿ãƒ³
    document.getElementById("phaser-play-btn").addEventListener("click", (e) => {
      if (bgm && bgm.isPlaying) {
        bgm.stop();
        e.target.innerHTML = "â–¶ï¸ Phaserã§å†ç”Ÿ"
      } else {
        if (!game) {
          game = new Phaser.Game(config);
          setTimeout(() => {
            bgm.play();
          }, 800); // èª­ã¿è¾¼ã¿ã®çŒ¶äºˆ
        } else {
          bgm.play();
        }
        e.target.innerHTML = "â¹ï¸ Phaseråœæ­¢"
      }
    });

    // éŸ³é‡èª¿æ•´ï¼ˆå…±é€šï¼‰
    const changeVolume = (delta) => {
      // audioã‚¿ã‚°
      if (!audioEl.paused) {
        let newVolume = Math.min(1, Math.max(0, audioEl.volume + delta));
        audioEl.volume = newVolume;
      }

      // Phaser
      if (bgm && bgm.isPlaying) {
        let phaserVol = Math.min(1, Math.max(0, bgm.volume + delta));
        bgm.setVolume(phaserVol);
      }
    };
    document.getElementById("volume-up").addEventListener("click", () => changeVolume(0.1));
    document.getElementById("volume-down").addEventListener("click", () => changeVolume(-0.1));


    // ===== ãƒã‚¤ã‚¯é–¢é€£ =====
    let stream;

    // ãƒã‚¤ã‚¯è¨±å¯
    document.getElementById("mic-btn").addEventListener("click", async (e) => {
      if (!stream) {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          document.getElementById("mic-status").textContent = "ãƒã‚¤ã‚¯çŠ¶æ…‹: ä½¿ç”¨è¨±å¯ã•ã‚Œã¾ã—ãŸ";
          console.log(stream);
          e.target.innerHTML = "ğŸ¤ ãƒã‚¤ã‚¯ã‚’æ­¢ã‚ã‚‹";
        } catch (err) {
          document.getElementById("mic-status").textContent = "ãƒã‚¤ã‚¯çŠ¶æ…‹: è¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ";
          console.error("ãƒã‚¤ã‚¯ã‚¨ãƒ©ãƒ¼:", err);
        }
      } else {

        try {
          console.log(stream);
          console.log(stream.getAudioTracks);
          console.log(`stream.getAudioTracks().length = ${stream.getAudioTracks().length}`);

          if (stream && stream.getAudioTracks) {
            stream.getAudioTracks().forEach(track => track.stop());
            // stream.getAudioTracks().forEach(track => track.enabled = false);
          }
          stream = null;

          document.getElementById("mic-status").textContent = "ãƒã‚¤ã‚¯çŠ¶æ…‹: stopã—ã¾ã—ãŸ";
          e.target.innerHTML = "ğŸ¤ ãƒã‚¤ã‚¯ã‚’ä½¿ã†";

        } catch (err) {
          document.getElementById("mic-status").textContent = "ãƒã‚¤ã‚¯çŠ¶æ…‹: åœæ­¢ã§ãã¾ã›ã‚“ã§ã—ãŸ";
          console.error("ãƒã‚¤ã‚¯ã‚¨ãƒ©ãƒ¼:", err);
        }
      }
    });



  </script>
</body>

</html>