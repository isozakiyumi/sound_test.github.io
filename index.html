<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒã‚¤ã‚¯ã¨MP3å†ç”Ÿ</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
</head>
<body>
  <h1>ãƒã‚¤ã‚¯ã¨MP3å†ç”Ÿ</h1>

  <p id="mic-status">ãƒã‚¤ã‚¯çŠ¶æ…‹: æœªç¢ºèª</p>

  <!-- ãƒã‚¤ã‚¯ä½¿ç”¨è¨±å¯ãƒœã‚¿ãƒ³ -->
  <button id="mic-btn">ğŸ¤ ãƒã‚¤ã‚¯ã‚’ä½¿ã†</button>
  <br><br>
  <!-- éŸ³å£°å†ç”Ÿãƒœã‚¿ãƒ³ -->
  <button id="play-btn">â–¶ï¸ éŸ³å£°ã‚’å†ç”Ÿ(Audio)</button>
  <button id="play-phaser-btn">â–¶ï¸ éŸ³å£°ã‚’å†ç”Ÿï¼ˆPhaserï¼‰</button>
  <br><br>
  <button id="stop-btn">â¹ï¸ éŸ³å£°ã‚’åœæ­¢</button>

  <!-- MP3 ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ -->
  <audio id="audio-player" loop>
    <source src="./test.mp3" type="audio/mpeg">
    ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ audio ã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
  </audio>

  <script>
    // ãƒã‚¤ã‚¯ä½¿ç”¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    async function requestMicrophoneAccess() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        document.getElementById("mic-status").textContent = "ãƒã‚¤ã‚¯çŠ¶æ…‹: ä½¿ç”¨è¨±å¯ã•ã‚Œã¾ã—ãŸ";
        // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½¿ç”¨ã—ãªã„ãªã‚‰åœæ­¢
        stream.getTracks().forEach(track => track.stop());
      } catch (err) {
        document.getElementById("mic-status").textContent = "ãƒã‚¤ã‚¯çŠ¶æ…‹: è¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ";
        console.error("ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:", err);
      }
    }

    let audio = null;
    // å†ç”Ÿå‡¦ç†
    function playAudio() {
      audio = document.getElementById("audio-player");
      audio.play().then(() => {
        console.log("å†ç”Ÿé–‹å§‹");
      }).catch(err => {
        console.error("å†ç”Ÿã«å¤±æ•—:", err);
      });
      
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
    document.getElementById("mic-btn").addEventListener("click", requestMicrophoneAccess);
    document.getElementById("play-btn").addEventListener("click", playAudio);


      // Phaserã‚²ãƒ¼ãƒ è¨­å®š
    const config = {
      type: Phaser.AUTO,
      width: 0,  // æç”»ãªã—ï¼ˆéŸ³å£°å†ç”Ÿã ã‘ï¼‰
      height: 0,
      parent: 'game',
      scene: {
        preload: preload,
        create: create
      }
    };

    let game = null;
    let bgm = null;

    function preload() {
      // ãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯ã‚µãƒ¼ãƒä¸Šã®MP3ã‚’æŒ‡å®š
      this.load.audio('bgm', ['./test.mp3']);
    }

    function create() {
      bgm = this.sound.add('bgm', { loop: true });
    }

    // å†ç”Ÿãƒœã‚¿ãƒ³ã§å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°
    function playBGM() {
      if (!game) {
        game = new Phaser.Game(config);
        // PhaserãŒå®Œå…¨ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰å†ç”Ÿ
        game.events.on('ready', () => {
          if (bgm) bgm.play();
        });
      } else {
        if (bgm && !bgm.isPlaying) {
          bgm.play();
        }
      }
    }

    // éŸ³å£°åœæ­¢å‡¦ç†
    function stopBGM() {
      if (bgm && bgm.isPlaying) {
        bgm.stop();
      }
      if (audio) {
         audio.pause();
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²

    document.getElementById("play-phaser-btn").addEventListener("click", playBGM);
    document.getElementById("stop-btn").addEventListener("click", stopBGM);
  </script>
</body>
</html>
